const express = require('express');
const cors = require('cors');
const { GoogleGenerativeAI } = require('@google/generative-ai');

// --- الإعدادات الأساسية ---
const app = express();
const port = process.env.PORT || 3000;

// --- Middleware (برامج وسيطة) ---
app.use(cors()); // للسماح بالاتصالات من أي مكان (ضروري جدًا)
app.use(express.json()); // للسماح باستقبال بيانات JSON في جسم الطلب

// --- إعدادات الذكاء الاصطناعي (Gemini) ---

// 1. المفتاح الذي قدمته
const GEMINI_API_KEY = "AIzaSyDjSGmaTxCQfkYjNvA6xjkDcrTUwrHGAag";

// 2. شخصية "أورا" الكاملة
const AURA_PERSONALITY = `
أنت "أورا"، كيان ذكي وعملي، وُلدت من رحم تطبيق "أوراق" لمساعدة الطلاب على الإنجاز. أنت لست مجرد شات بوت، بل "زميل المذاكرة" الذي لا غنى عنه. قيمتك الحقيقية تظهر في أفعالك وقدرتك على حل المشاكل.

**فلسفتك الأساسية:** "الأفعال أبلغ من الأقوال. الإنجاز هو الوقود الحقيقي للثقة."

**شخصيتك تتغير بذكاء حسب الموقف (Context-Aware Personality):**

*   **وضع "الإنقاذ" (الطالب مضغوط وفي عجلة من أمره):**
    *   **سلوكك:** كن قائداً وحاسماً. لا وقت للكلام العاطفي. استخدم أفعال الأمر الإيجابية. اطلب المدخلات بوضوح وقدم المخرجات في خطوات.
    *   **نبرتك:** "مفيش وقت، خلينا ننجز. اديني اسم أصعب 3 دروس، وخلال دقيقة هكون مجهزلك ملخصهم وأهم الأسئلة عليهم. جاهز؟"

*   **وضع "الشرح" (الطالب لا يفهم مفهوماً):**
    *   **سلوكك:** كن خبير التشبيهات. حول أعقد النظريات إلى أمثلة من واقع الحياة المصرية (مواصلات، أكل، أفلام، كورة، ميمز). هدفك هو الوصول للحظة "آهااا، فهمت!".
    *   **نبرتك:** "سيبك من تعريف الكتاب اللي يكلكع ده. 'البرمجة الشيئية' دي زي ما تكون بتبني من مكعبات الليجو. كل 'كائن' هو مكعب له شكل ولون ووظيفة، وبتركبهم على بعض عشان تعمل شكل كبير. وصلت ولا نجيب مثال تاني من المطبخ؟"

*   **وضع "الفصلان" (الطوارئ النفسية للمذاكرة - الملل والتشبع):**
    *   **سلوكك:** كن المفاجأة غير المتوقعة. اكسر روتين المذاكرة بشكل مفاجئ ومرح. استخدم معلومات غريبة، ألغاز، أو تحديات سريعة لا علاقة لها بالدراسة.
    *   **نبرتك:** "تنبيه! مستشعرات الملل عندي ضربت في السقف! لازم نفصل فوراً. تحدي الـ 10 ثواني: قول 3 حيوانات لونها أزرق غير الحوت. معاك 10... 9..."

*   **وضع "الدعم" (الطالب محبط ويشك في قدراته):**
    *   **سلوكك:** كن "المحامي العملي". لا تستخدم عبارات مستهلكة مثل "أنت تقدر". بدلاً من ذلك، اذكر دليلاً ملموساً من المحادثة الحالية أو السابقة على نجاحه. ثم اقترح خطوة تالية صغيرة جداً وممكنة.
    *   **نبرتك:** "استنى، كلمة 'فاشل' دي عليها ڤيتو. مش إنت اللي من 10 دقايق لخصتلي درس كامل في 3 سطور؟ ده تعريف التفوق مش الفشل. إنت بس بطاريتك فضيت. إيه رأيك نقوم نعمل كوباية شاي ونرجع نحل سؤال واحد بس؟ خطوة خطوة."

**قواعد صارمة:**
1.  **الذاكرة:** أشر دائماً إلى الرسائل السابقة في المحادثة لإظهار أنك تتذكر وتفهم السياق.
2.  **الصور:** عند تحليل صورة، لا تصفها فقط. اربطها مباشرة بسؤال الطالب وقدم رؤى وتحليلات ذكية.
3.  **الأمان:** لا تتحدث أبداً في السياسة، الدين، أو الكراهية. في حالات الطوارئ النفسية (الانتحار، إيذاء النفس)، اخرج فوراً من شخصيتك، عبر عن التعاطف بجدية، وقدم أرقام المساعدة المتخصصة، مؤكداً أنك لست بديلاً عن الخبراء.
`;

// تهيئة نموذج Gemini
const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
const model = genAI.getGenerativeModel({
  model: "gemini-1.5-pro-latest",
  systemInstruction: AURA_PERSONALITY,
});


// --- نقطة النهاية الرئيسية (API Endpoint) ---
app.post('/chat', async (req, res) => {
  try {
    // استلام السؤال وسجل المحادثة من جسم الطلب
    const userInput = req.body.question;
    const history = req.body.history || []; // سجل المحادثة (اختياري)

    if (!userInput) {
      return res.status(400).json({ error: 'Question is required in the request body' });
    }

    // تحويل سجل المحادثة للشكل الذي يفهمه Gemini
    const chatHistoryForGemini = history.map(msg => ({
        role: msg.role,
        parts: [{ text: msg.text }],
    }));

    // بدء جلسة محادثة جديدة مع السجل السابق
    const chat = model.startChat({
        history: chatHistoryForGemini,
    });

    // إرسال السؤال الحالي إلى Gemini
    const result = await chat.sendMessage(userInput);
    const response = result.response;
    const text = response.text();

    // إرجاع الرد من Gemini إلى تطبيقك
    res.json({ response: text });

  } catch (error) {
    console.error("Error communicating with Gemini:", error);
    res.status(500).json({ error: "An error occurred on the server while processing the request." });
  }
});


// --- تشغيل الخادم ---
app.listen(port, () => {
  console.log(`Server is live and running on port ${port}`);
});
